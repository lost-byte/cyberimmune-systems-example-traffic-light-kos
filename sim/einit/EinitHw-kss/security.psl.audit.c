#include "kssaudit/decode.h"
#include "nk/types.h"
static const nk_size_t psl_segment_bytes_len = 352U;
#include "kssaudit/machine.h"
#include "kss/audit-gen-api.h"
#include "kss/audit.h"
#include "kssaudit/constants.h"
#include "kssaudit/segment.h"
#include "kss/kss.h"
static const nk_uint8_t psl_segment_bytes[] = {0x02, 0x00, 0x00, 0x80, 0x40,
                                               0x01, 0x00, 0x90, 0x00, 0x00,
                                               0x00, 0x00, 0x20, 0x00, 0x00,
                                               0x00, 0x01, 0x00, 0x00, 0x00,
                                               0x20, 0x00, 0x00, 0x00, 0x00,
                                               0x00, 0x00, 0x00, 0x60, 0x01,
                                               0x00, 0x00, 0x02, 0x00, 0x00,
                                               0x80, 0x10, 0x01, 0x00, 0x90,
                                               0x00, 0x00, 0x00, 0x00, 0x20,
                                               0x00, 0x00, 0x00, 0x01, 0x00,
                                               0x00, 0x00, 0x30, 0x01, 0x00,
                                               0x00, 0x00, 0x00, 0x00, 0x00,
                                               0x40, 0x01, 0x00, 0x00, 0x01,
                                               0x00, 0x00, 0x80, 0xf6, 0x00,
                                               0x00, 0x80, 0x00, 0x00, 0x00,
                                               0x00, 0x38, 0x00, 0x00, 0x00,
                                               0x00, 0x00, 0x00, 0x00, 0x2e,
                                               0x01, 0x00, 0x00, 0x10, 0x00,
                                               0x00, 0x03, 0x00, 0x00, 0x00,
                                               0x00, 0x17, 0x18, 0x27, 0x00,
                                               0x00, 0x00, 0x04, 0x0e, 0x00,
                                               0x00, 0x00, 0x65, 0x78, 0x70,
                                               0x6c, 0x69, 0x63, 0x69, 0x74,
                                               0x20, 0x67, 0x72, 0x61, 0x6e,
                                               0x74, 0x00, 0x19, 0xf6, 0x00,
                                               0x00, 0x00, 0x10, 0x00, 0x00,
                                               0x03, 0x01, 0x00, 0x00, 0x00,
                                               0x17, 0x18, 0x51, 0x00, 0x00,
                                               0x00, 0x04, 0x11, 0x00, 0x00,
                                               0x00, 0x63, 0x6f, 0x6e, 0x64,
                                               0x69, 0x74, 0x69, 0x6f, 0x6e,
                                               0x61, 0x6c, 0x20, 0x67, 0x72,
                                               0x61, 0x6e, 0x74, 0x00, 0x19,
                                               0xf6, 0x00, 0x00, 0x00, 0x10,
                                               0x00, 0x00, 0x03, 0x02, 0x00,
                                               0x00, 0x00, 0x17, 0x18, 0x77,
                                               0x00, 0x00, 0x00, 0x04, 0x0d,
                                               0x00, 0x00, 0x00, 0x65, 0x78,
                                               0x70, 0x6c, 0x69, 0x63, 0x69,
                                               0x74, 0x20, 0x64, 0x65, 0x6e,
                                               0x79, 0x00, 0x19, 0xf6, 0x00,
                                               0x00, 0x00, 0x10, 0x00, 0x00,
                                               0x03, 0x03, 0x00, 0x00, 0x00,
                                               0x17, 0x18, 0xa0, 0x00, 0x00,
                                               0x00, 0x04, 0x10, 0x00, 0x00,
                                               0x00, 0x63, 0x6f, 0x6e, 0x64,
                                               0x69, 0x74, 0x69, 0x6f, 0x6e,
                                               0x61, 0x6c, 0x20, 0x64, 0x65,
                                               0x6e, 0x79, 0x00, 0x19, 0xf6,
                                               0x00, 0x00, 0x00, 0x10, 0x00,
                                               0x00, 0x03, 0x04, 0x00, 0x00,
                                               0x00, 0x17, 0x18, 0xde, 0x00,
                                               0x00, 0x00, 0x0e, 0x05, 0x00,
                                               0x13, 0x0e, 0x04, 0x00, 0x13,
                                               0x04, 0x1d, 0x00, 0x00, 0x00,
                                               0x61, 0x75, 0x64, 0x69, 0x74,
                                               0x20, 0x6c, 0x65, 0x76, 0x65,
                                               0x6c, 0x20, 0x63, 0x68, 0x61,
                                               0x6e, 0x67, 0x65, 0x64, 0x3a,
                                               0x20, 0x25, 0x31, 0x20, 0x2d,
                                               0x3e, 0x20, 0x25, 0x32, 0x00,
                                               0x19, 0xf6, 0x00, 0x00, 0x00,
                                               0x04, 0x12, 0x00, 0x00, 0x00,
                                               0x6e, 0x6f, 0x20, 0x6f, 0x70,
                                               0x74, 0x69, 0x6f, 0x6e, 0x20,
                                               0x73, 0x65, 0x6c, 0x65, 0x63,
                                               0x74, 0x65, 0x64, 0x1b, 0x00,
                                               0x00, 0x00, 0x00, 0x00, 0x80,
                                               0x00, 0x00, 0x00, 0x90, 0x00,
                                               0x00, 0x00, 0x00, 0x40, 0x01,
                                               0x00, 0x00};
#include "kss/types.h"
nk_err_t __kss_audit_decode(const void *msg, const void *data, char *buf, const
                            nk_size_t size)
{
    int rc = NK_EOK;
    nk_size_t written;
    const kss_audit_header *header = (const kss_audit_header *) msg;
    nk_size_t min_size = nk_min(size - 1, header->size);
    
    switch (header->tag) {
        
      case KSS_AUDIT_MESSAGE_FORMAT_PLAINTEXT:
        nk_memcpy(buf, data, min_size);
        buf[min_size] = '\0';
        rc = NK_EOK;
        break;
        
      case KSS_AUDIT_MESSAGE_FORMAT_CBOR:
        written = CBOR_to_JSON((const nk_uint8_t *) data, header->size, buf,
                               size);
        if (written > size) {
            rc = NK_ENOMEM;
            break;
        }
        break;
        
      default:
        rc = machine_run_providers(header->tag, data, (nk_size_t) header->size,
                                   psl_segment_bytes, psl_segment_bytes_len,
                                   buf, size - 1, &written);
        buf[rc == NK_EOK ? nk_max(written, size - 1) : size - 1] = '\0';
    }
    return rc;
}
